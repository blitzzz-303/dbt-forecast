version: 2
warn_default_conf: &warn_default_conf
  severity: warn
  warn_if: '>1'
  store_failures: true

warn_default_conf: &warn_data_drift_detection
  severity: warn
  warn_if: '>8'
  store_failures: true

models:
  - name: INT_PROPHET__ML_TRAIN
    description: training & storing model's score & parameters
    config:
      stores: "{{ var('stores') }}"
      depts: "{{ var('depts') }}"
    tests:
      - dbt_utils.expression_is_true:
          config: *warn_default_conf
          expression: "MAPE <= 0.1"
    columns:
      - name: category
        tests:
          - relationships:
              to: ref('INT_PROPHET__SALES_TRAIN')
              field: store_dept_pk
        description: |
          model category, created by combining store # and dept #
      - name: MSE
        description: |
          mean squared error (main metric), formula: sum((predict - actual)^2) / n
      - name: MAPE
        description: |
          mean absolute percentage error, formula: sum(abs(predict - actual) / actual) / n
      - name: RMSE
        description: |
          root mean squared error, formula: sqrt(sum((predict - actual)^2) / n)
      - name: params
        description: |
          model best parameters, data sample: {"changepoint_prior_scale": 0.05, "seasonality_prior_scale": 0.05}
      - name: training_time_second
        description: |
          model training time (in seconds)
      - name: max_workers
        description: |
          number of workers used for training
      - name: train_at
        description: |
          training time
      - name: holiday
        description: |
          country holiday parameter (optional)
      - name: memory
        description: |
          cluster memory (unable to track atm)
  - name: PROPHET__EVALUATE
    description: sales evaluation table
    tests:
      - dbt_utils.expression_is_true:
          config: *warn_data_drift_detection
          # mark as failed if the data drift is greater than 20%
          expression: "monthly_sales_error < 0.2"
    columns:
      - name: store
        description: |
          store id
      - name: dept
        description: |
          department id
      - name: weekly_sales
        description: |
          weekly sales amount
      - name: week_date 
        description: |
          date field, already converted to week
      - name: sales_upper
        description: |
          upper bound of sales amount
      - name: sales_lower
        description: |
          lower bound of sales amount
      - name: sales_predict
        description: |
          predict sales amount, use this field for model evaluation
          or when the PROMPT has PREDICT keyword in it
